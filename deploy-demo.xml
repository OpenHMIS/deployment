<?xml version="1.0" encoding="UTF-8"?>
<project name="tomcat-deploy" default="war">
	<path id="catalina-ant-classpath">
	    <fileset dir="lib">
	        <include name="catalina-ant.jar"/>
	        <include name="tomcat-coyote.jar"/>
	        <include name="tomcat-util.jar"/>
	        <include name="tomcat-juli.jar"/>
	    </fileset>
	</path>
	
	<taskdef resource="net/sf/antcontrib/antlib.xml">
  		<classpath>
    		<pathelement location="lib/ant-contrib-1.0b3.jar"/>
  		</classpath>
	</taskdef>

	<taskdef name="start" classname="org.apache.catalina.ant.StartTask" />
	<taskdef name="stop" classname="org.apache.catalina.ant.StopTask" />
	
	<property name="project-name" value="openmrs" />
	<property name="tomcat-manager-url" value="http://localhost:8081/manager/text" />
	<property name="openmrs-module-dir" value="/usr/share/tomcat7/.OpenMRS/modules" />

	<target name="stop" description="stop application in tomcat">
		<stop url="${tomcat-manager-url}" username="${tomcat-manager-username}"
			password="${tomcat-manager-password}" path="/${project-name}"
			failonerror="false" />
	</target>

	<target name="start" description="start application in tomcat">
		<start url="${tomcat-manager-url}" username="${tomcat-manager-username}"
			password="${tomcat-manager-password}" path="/${project-name}" />
	</target>
	
	<target name="copy_modules">
		<!-- Copy included modules to mod_deploy directory -->
		<copy todir="mod_deploy">
			<fileset dir="dependencies">
				<include name="*.omod" />
			</fileset>
		</copy>

		<!-- Update each module in the mod_deploy folder -->
		<foreach param="module" target="update-module">
			<fileset id="modules" dir="mod_deploy">
			<include name="*.omod" />
		</fileset>
		</foreach>
	</target>

	<target name="update-module">
		<!-- Get module id from module file name -->
			<basename property="module.filename" file="${module}" />
			<propertyregex property="module_id"
				input="${module.filename}"
				regexp="^([^-]+)"
				select="\0" />

			<!-- Remove any modules with specified module id from tomcat openmrs module folder -->
			<delete>
				<fileset dir="${openmrs-module-dir}">
					<include name="${module_id}*.omod" />
				</fileset>
			</delete>

			<echo message="Module file: ${module}" />

			<!-- Copy modules into tomcat openmrs module folder -->
			<copy todir="${openmrs-module-dir}" file="${module}" />
	</target>
</project>